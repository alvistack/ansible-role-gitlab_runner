#!/bin/bash

# (c) Wong Hoi Sing Edison <hswong3i@pantarei-design.com>
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

set -ex

HOSTNAME="runner-${CUSTOM_ENV_CI_RUNNER_ID}-project-${CUSTOM_ENV_CI_PROJECT_ID}-concurrent-${CUSTOM_ENV_CI_CONCURRENT_PROJECT_ID}"
echo ${HOSTNAME} > HOSTNAME

CI_JOB_URL="${CUSTOM_ENV_CI_JOB_URL}"
echo ${CI_JOB_URL} > CI_JOB_URL

cat > Vagrantfile <<EOF
Vagrant.configure("2") do |config|
  config.vm.define '${HOSTNAME}' do |instance|
    instance.vm.hostname = '${HOSTNAME}'
    instance.vm.box = '{{ gitlab_runner_runners_vagrant_image }}'
  end
  
  config.vm.provider :libvirt do |libvirt|
    libvirt.cpus = {{ gitlab_runner_runners_vagrant_cpus }}
    libvirt.memory = {{ gitlab_runner_runners_vagrant_memory }}
    libvirt.nested = {{ gitlab_runner_runners_vagrant_nested | bool | lower }}
    libvirt.cpu_mode = 'host-model'
  end
  
  config.vm.provision 'shell', inline: <<-SHELL
    sudo apt-get update
    sudo apt-get install -y git git-lfs
    sudo chown -Rf vagrant:vagrant {{ gitlab_runner_runners_builds_dir }}
    sudo chown -Rf vagrant:vagrant {{ gitlab_runner_runners_cache_dir }}
  SHELL
  
{% for synced_folder in gitlab_runner_runners_vagrant_synced_folders %}
  config.vm.synced_folder '{{ synced_folder.src }}', '{{ synced_folder.dest }}'
{% endfor %}
end
EOF
